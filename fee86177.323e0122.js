(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{135:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return o})),a.d(t,"toc",(function(){return c})),a.d(t,"default",(function(){return b}));var n=a(3),r=a(7),i=(a(0),a(139)),s={id:"entity_framework",title:"Entity Framework Core"},o={unversionedId:"entity_framework",id:"entity_framework",isDocsHomePage:!1,title:"Entity Framework Core",description:"Introduction",source:"@site/docs/entity_framework.md",slug:"/entity_framework",permalink:"/API-Playbook/entity_framework",editUrl:"https://github.com/LBHackney-IT/API-Playbook/edit/master/docs/entity_framework.md",version:"current",sidebar:"docs",previous:{title:"Serverless Lambda Framework",permalink:"/API-Playbook/serverless_lambda"},next:{title:"Listener Tech Stack",permalink:"/API-Playbook/listener_tech_stack"}},c=[{value:"Introduction",id:"introduction",children:[]},{value:"Video Tutorial",id:"video-tutorial",children:[]},{value:"How is it implemented in the Base API?",id:"how-is-it-implemented-in-the-base-api",children:[]},{value:"Examples of Use",id:"examples-of-use",children:[]},{value:"More Information",id:"more-information",children:[]}],l={toc:c};function b(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"introduction"},"Introduction"),Object(i.b)("p",null,"Entity Framework Core is an object-relational mapper that lets .NET developers work with a database using .NET objects. "),Object(i.b)("p",null,"This reduces the amount of data-access code that needs to be written. "),Object(i.b)("p",null,"This means that instead of writing code to directly interact with our databases, we can instead create a ",Object(i.b)("strong",{parentName:"p"},"domain")," class which identifies the database from which we\u2019re retrieving our data and maps column titles to the properties of that class."),Object(i.b)("h2",{id:"video-tutorial"},"Video Tutorial"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"}," Watch a video version of this page if you prefer! ")),Object(i.b)("figure",{class:"video-container"},Object(i.b)("iframe",{width:"100",src:"https://www.youtube.com/embed/qNsqZCKefcc",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0})),Object(i.b)("h2",{id:"how-is-it-implemented-in-the-base-api"},"How is it implemented in the Base API?"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-dotnet",metastring:'title="./BaseApi/V1/Infrastructure/DatabaseContext.cs"',title:'"./BaseApi/V1/Infrastructure/DatabaseContext.cs"'},"using Microsoft.EntityFrameworkCore;\n\nnamespace BaseApi.V1.Infrastructure\n{\n\n    public class DatabaseContext : DbContext\n    {\n        //TODO: rename DatabaseContext to reflect the data source it is representing. eg. MosaicContext.\n        //Guidance on the context class can be found here https://github.com/LBHackney-IT/lbh-base-api/wiki/DatabaseContext\n        public DatabaseContext(DbContextOptions options) : base(options)\n        {\n        }\n\n        public DbSet<DatabaseEntity> DatabaseEntities { get; set; }\n    }\n}\n")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"We call ",Object(i.b)("inlineCode",{parentName:"p"},"EntityFrameworkCore")," within the ",Object(i.b)("inlineCode",{parentName:"p"},"DatabaseContext.cs")," file in the infrastructure namespace. ")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"We then create a ",Object(i.b)("inlineCode",{parentName:"p"},"DatabaseContext")," Class, which inherits methods from ",Object(i.b)("inlineCode",{parentName:"p"},"DbContext")," - a part of EntityFrameworkCore. If necessary, we can extend the methods in DBContext using an override modifier.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"The most important part of this class are the ",Object(i.b)("inlineCode",{parentName:"p"},"properties"),", which are formed with a ",Object(i.b)("inlineCode",{parentName:"p"},"DbSet")," attached to a specific object. "),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},"We define this object using a ",Object(i.b)("inlineCode",{parentName:"li"},"DatabaseEntity")," model.")))),Object(i.b)("h2",{id:"examples-of-use"},"Examples of Use"),Object(i.b)("p",null,"EntityFrameworkCore uses the DatabaseEntity model when accessing the database. In the API team, we typically create an individual file within the Infrastructure namespace for each individual table in the database. "),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-dotnet",metastring:'title="./BaseApi/V1/Infrastructure/DatabaseEntity.cs" {18,22,26}',title:'"./BaseApi/V1/Infrastructure/DatabaseEntity.cs"',"{18,22,26}":!0},'using Amazon.DynamoDBv2.DataModel;\nusing System;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace BaseApi.V1.Infrastructure\n{\n    //TODO: rename table and add needed fields relating to the table columns.\n    // There\'s an example of this in the wiki https://github.com/LBHackney-IT/lbh-base-api/wiki/DatabaseContext\n\n    //TODO: Pick the attributes for the required data source, delete the others as appropriate\n    // Postgres will use the "Table" and "Column" attributes\n    // DynamoDB will use the "DynamoDBTable", "DynamoDBHashKey" and "DynamoDBProperty" attributes\n\n    //TODO: For DynamoDB...\n    // * The table name must match that specified in the terraform step that provisions the DynamoDb resource\n    // * The name of the hash key property must match that specified in the terraform step that provisions the DynamoDb resource\n\n    [Table("example_table")]\n    [DynamoDBTable("example_table", LowerCamelCaseProperties = true)]\n    public class DatabaseEntity\n    {\n        [Column("id")]\n        [DynamoDBHashKey]\n        public int Id { get; set; }\n\n        [Column("created_at")]\n        [DynamoDBProperty]\n        public DateTime CreatedAt { get; set; }\n    }\n}\n')),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Example DatabaseEntity for the Base API")),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-sql",metastring:'title="./database/schema.sql"',title:'"./database/schema.sql"'},"CREATE TABLE example_table (\n    created_at timestamp ,\n    id SERIAL PRIMARY KEY\n);\n")),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Schema that we use to create an example table in our database")),Object(i.b)("p",null,"The class for each DatabaseEntity has a Table attribute, which directly references a specific table present in the schema."),Object(i.b)("p",null,"There are also Column attributes for each property, which also directly reference the names of the columns, as well as the data types."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-dotnet",metastring:'title="./BaseApi/V1/Gateways/ExampleGateway.cs" {20}',title:'"./BaseApi/V1/Gateways/ExampleGateway.cs"',"{20}":!0},"using System.Collections.Generic;\nusing BaseApi.V1.Domain;\nusing BaseApi.V1.Factories;\nusing BaseApi.V1.Infrastructure;\n\nnamespace BaseApi.V1.Gateways\n{\n    //TODO: Rename to match the data source that is being accessed in the gateway eg. MosaicGateway\n    public class ExampleGateway : IExampleGateway\n    {\n        private readonly DatabaseContext _databaseContext;\n\n        public ExampleGateway(DatabaseContext databaseContext)\n        {\n            _databaseContext = databaseContext;\n        }\n\n        public Entity GetEntityById(int id)\n        {\n            var result = _databaseContext.DatabaseEntities.Find(id);\n\n            return result?.ToDomain();\n        }\n\n        public List<Entity> GetAll()\n        {\n            return new List<Entity>();\n        }\n    }\n}\n")),Object(i.b)("p",null,"With our model built, we can now call our DatabaseContext object within the ",Object(i.b)("strong",{parentName:"p"},"Gateway"),", and access the database using LINQ queries. "),Object(i.b)("p",null,"For example, in the ",Object(i.b)("inlineCode",{parentName:"p"},"GetEntityById")," method, we call the Database Context, access the DatabaseEntity Property and use the ",Object(i.b)("inlineCode",{parentName:"p"},"Find")," method to match the id in our request with the id column in our database."),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"find")," method is one of many methods within EntityFrameworkCore."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-dotnet",metastring:'title="./BaseApi.Tests/V1/Gateways/ExampleGatewayTests.cs" {37,38,39,40,41}',title:'"./BaseApi.Tests/V1/Gateways/ExampleGatewayTests.cs"',"{37,38,39,40,41}":!0},"using AutoFixture;\nusing BaseApi.Tests.V1.Helper;\nusing BaseApi.V1.Domain;\nusing BaseApi.V1.Gateways;\nusing FluentAssertions;\nusing NUnit.Framework;\n\nnamespace BaseApi.Tests.V1.Gateways\n{\n    //TODO: Remove this file if Postgres gateway is not being used\n    //TODO: Rename Tests to match gateway name\n    //For instruction on how to run tests please see the wiki: https://github.com/LBHackney-IT/lbh-base-api/wiki/Running-the-test-suite.\n    [TestFixture]\n    public class ExampleGatewayTests : DatabaseTests\n    {\n        private readonly Fixture _fixture = new Fixture();\n        private ExampleGateway _classUnderTest;\n\n        [SetUp]\n        public void Setup()\n        {\n            _classUnderTest = new ExampleGateway(DatabaseContext);\n        }\n\n        [Test]\n        public void GetEntityByIdReturnsNullIfEntityDoesntExist()\n        {\n            var response = _classUnderTest.GetEntityById(123);\n\n            response.Should().BeNull();\n        }\n\n        [Test]\n        public void GetEntityByIdReturnsTheEntityIfItExists()\n        {\n            // Arrange\n            var entity = _fixture.Create<Entity>();\n            var databaseEntity = DatabaseEntityHelper.CreateDatabaseEntityFrom(entity);\n\n            DatabaseContext.DatabaseEntities.Add(databaseEntity);\n            DatabaseContext.SaveChanges();\n\n            // Act\n            var response = _classUnderTest.GetEntityById(databaseEntity.Id);\n\n            // Assert\n            databaseEntity.Id.Should().Be(response.Id);\n            databaseEntity.CreatedAt.Should().BeSameDateAs(response.CreatedAt);\n        }\n\n        //TODO: Add tests here for the get all method.\n    }\n}\n")),Object(i.b)("p",null,"We can see more methods in use when creating tests which require pre-existing data in the database."),Object(i.b)("p",null,"Within our GatewayTests, during the ",Object(i.b)("inlineCode",{parentName:"p"},"arrange")," step shown we create a databaseEntity, then add that entity using the ",Object(i.b)("inlineCode",{parentName:"p"},"Add")," method to track the change to our table, then use the ",Object(i.b)("inlineCode",{parentName:"p"},"SaveChanges")," method to commit that change, as well as any other changes to the database."),Object(i.b)("h2",{id:"more-information"},"More Information"),Object(i.b)("p",null,"For more information, please visit the ",Object(i.b)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/ef/core/"},"online documentation")," for Entity Framework."))}b.isMDXComponent=!0},139:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return d}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),b=function(e){var t=r.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=b(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=b(a),m=n,d=p["".concat(s,".").concat(m)]||p[m]||u[m]||i;return a?r.a.createElement(d,o(o({ref:t},l),{},{components:a})):r.a.createElement(d,o({ref:t},l))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,s=new Array(i);s[0]=m;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:n,s[1]=o;for(var l=2;l<i;l++)s[l]=a[l];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);